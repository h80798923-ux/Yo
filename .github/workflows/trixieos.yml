name: Build TrixieOS (Buildroot Stable + LXQt)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential git bc bison flex libssl-dev libelf-dev \
          rsync cpio unzip file wget \
          xorriso grub-pc-bin grub-efi-amd64-bin

    - name: Clone Buildroot (STABLE)
      run: |
        git clone https://github.com/buildroot/buildroot.git
        cd buildroot
        git checkout 2024.02

    - name: Base config
      run: |
        cd buildroot
        make qemu_x86_64_defconfig

    - name: Custom TrixieOS config
      run: |
        cd buildroot
        cat >> .config << 'EOF'
        BR2_TARGET_GENERIC_HOSTNAME="TrixieOS"
        BR2_TARGET_GENERIC_ISSUE="TrixieOS - ProjectA tarafından yapıldı"

        BR2_INIT_BUSYBOX=y

        BR2_LINUX_KERNEL=y
        BR2_LINUX_KERNEL_USE_DEFCONFIG=y

        # Paket yöneticisi
        BR2_PACKAGE_OPKG=y

        # X11
        BR2_PACKAGE_XORG7=y
        BR2_PACKAGE_XSERVER_XORG_SERVER=y
        BR2_PACKAGE_XINIT=y

        # LXQt
        BR2_PACKAGE_LXQT=y
        BR2_PACKAGE_LXQT_PANEL=y
        BR2_PACKAGE_LXQT_SESSION=y
        BR2_PACKAGE_LXQT_CONFIG=y
        BR2_PACKAGE_LXQT_RUNNER=y
        BR2_PACKAGE_LXQT_QTERMINAL=y

        # Window manager
        BR2_PACKAGE_OPENBOX=y

        # Login manager
        BR2_PACKAGE_LIGHTDM=y
        BR2_PACKAGE_LIGHTDM_GTK_GREETER=y

        # Tema (yuvarlak Qt hissi)
        BR2_PACKAGE_QTCURVE=y

        # Terminal
        BR2_PACKAGE_XTERM=y

        # ISO + GRUB
        BR2_PACKAGE_GRUB2=y
        BR2_TARGET_ROOTFS_ISO9660=y
        BR2_TARGET_ROOTFS_ISO9660_VOLUME_ID="TrixieOS"
        EOF

        make olddefconfig

    - name: Installer overlay
      run: |
        cd buildroot
        mkdir -p board/trixieos/overlay/usr/bin

        cat > board/trixieos/overlay/usr/bin/trixie-installer << 'EOF'
        #!/bin/sh
        echo "TrixieOS Installer - ProjectA"
        DISK=/dev/sda
        wipefs -a $DISK
        parted -s $DISK mklabel msdos
        parted -s $DISK mkpart primary ext4 1MiB 100%
        mkfs.ext4 ${DISK}1
        mount ${DISK}1 /mnt
        cp -a /target/* /mnt/
        grub-install --boot-directory=/mnt/boot $DISK
        chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg
        reboot
        EOF

        chmod +x board/trixieos/overlay/usr/bin/trixie-installer
        echo 'BR2_ROOTFS_OVERLAY="board/trixieos/overlay"' >> .config
        make olddefconfig

    - name: Build Installer ISO
      run: |
        cd buildroot
        make -j$(nproc)
        cp output/images/rootfs.iso9660 TrixieOS-Installer.iso

    - name: Build Live ISO
      run: |
        cd buildroot
        sed -i 's|BR2_ROOTFS_OVERLAY.*|# BR2_ROOTFS_OVERLAY not set|' .config
        make olddefconfig
        make -j$(nproc)
        cp output/images/rootfs.iso9660 TrixieOS-Live.iso

    - uses: actions/upload-artifact@v4
      with:
        name: TrixieOS-ISOs
        path: |
          buildroot/TrixieOS-Installer.iso
          buildroot/TrixieOS-Live.iso
