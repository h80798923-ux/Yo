name: Build TrixieOS (Buildroot Stable)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential gcc g++ bc bison flex \
          git rsync cpio unzip file \
          libncurses5-dev libssl-dev \
          xorriso grub-pc-bin grub-efi-amd64-bin

    - name: Clone Buildroot
      run: |
        git clone https://github.com/buildroot/buildroot.git
        cd buildroot
        git checkout 2024.02

    # ---------------- KERNEL CONFIG ----------------
    - name: Kernel config
      run: |
        cd buildroot
        mkdir -p board/trixieos
        cat > board/trixieos/linux.config << 'EOF'
        CONFIG_64BIT=y
        CONFIG_X86_64=y
        CONFIG_SMP=y
        CONFIG_PREEMPT=y
        CONFIG_BLK_DEV_INITRD=y
        CONFIG_DEVTMPFS=y
        CONFIG_DEVTMPFS_MOUNT=y
        CONFIG_VT=y
        CONFIG_VT_CONSOLE=y
        CONFIG_FB=y
        CONFIG_DRM=y
        CONFIG_DRM_I915=y
        CONFIG_INPUT_EVDEV=y
        CONFIG_EXT4_FS=y
        CONFIG_SQUASHFS=y
        CONFIG_ISO9660_FS=y
        CONFIG_EFI=y
        CONFIG_EFI_STUB=y
        EOF

    # ---------------- BUILDROOT CONFIG ----------------
    - name: Buildroot defconfig
      run: |
        cd buildroot
        cat > configs/trixieos_defconfig << 'EOF'
        BR2_x86_64=y
        BR2_TOOLCHAIN_BUILDROOT_GLIBC=y
        BR2_INIT_BUSYBOX=y

        BR2_LINUX_KERNEL=y
        BR2_LINUX_KERNEL_CUSTOM_CONFIG_FILE="board/trixieos/linux.config"

        BR2_PACKAGE_XORG7=y
        BR2_PACKAGE_XSERVER_XORG_SERVER=y
        BR2_PACKAGE_XINIT=y
        BR2_PACKAGE_FLUXBOX=y
        BR2_PACKAGE_XTERM=y

        BR2_PACKAGE_GRUB2=y
        BR2_TARGET_ROOTFS_ISO9660=y
        BR2_TARGET_ROOTFS_ISO9660_VOLUME_ID="TrixieOS"

        BR2_TARGET_GENERIC_HOSTNAME="TrixieOS"
        BR2_TARGET_GENERIC_ISSUE="TrixieOS - ProjectA tarafından yapıldı"
        EOF

        make trixieos_defconfig

    # ---------------- INSTALLER ----------------
    - name: Installer overlay
      run: |
        cd buildroot
        mkdir -p overlay/usr/bin
        cat > overlay/usr/bin/trixie-installer << 'EOF'
        #!/bin/sh
        set -e
        DISK=/dev/sda
        echo "TrixieOS Installer"
        wipefs -a $DISK
        parted -s $DISK mklabel msdos
        parted -s $DISK mkpart primary ext4 1MiB 100%
        mkfs.ext4 ${DISK}1
        mount ${DISK}1 /mnt
        cp -a /target/* /mnt/
        grub-install --boot-directory=/mnt/boot $DISK
        chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg
        umount -R /mnt
        reboot
        EOF
        chmod +x overlay/usr/bin/trixie-installer
        echo 'BR2_ROOTFS_OVERLAY="overlay"' >> .config

    # ---------------- BUILD ----------------
    - name: Build ISO
      run: |
        cd buildroot
        make -j$(nproc)

    - name: Rename ISO
      run: |
        cd buildroot/output/images
        cp rootfs.iso9660 TrixieOS-Live.iso
        cp rootfs.iso9660 TrixieOS-Installer.iso

    - uses: actions/upload-artifact@v4
      with:
        name: TrixieOS
        path: |
          buildroot/output/images/TrixieOS-Live.iso
          buildroot/output/images/TrixieOS-Installer.iso
