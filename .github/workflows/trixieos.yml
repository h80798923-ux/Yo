name: Build TrixieOS (Buildroot Stable ISO)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential git bc bison flex libssl-dev libelf-dev \
          cpio rsync xorriso grub-pc-bin grub-efi-amd64-bin \
          libncurses5-dev libncursesw5-dev wget

    - name: Clone Buildroot (STABLE)
      run: |
        git clone https://github.com/buildroot/buildroot.git
        cd buildroot
        git checkout 2024.02

    - name: Configure Buildroot (KERNEL DEFCONFIG FIXED)
      run: |
        cd buildroot
        make defconfig

        ./support/scripts/config \
          --enable BR2_x86_64 \
          --enable BR2_TOOLCHAIN_BUILDROOT_GLIBC \
          --enable BR2_INIT_BUSYBOX \
          --enable BR2_TARGET_GENERIC_GETTY \
          --set-str BR2_TARGET_GENERIC_HOSTNAME "TrixieOS" \
          --set-str BR2_TARGET_GENERIC_ISSUE "TrixieOS - ProjectA tarafından yapıldı" \
          \
          --enable BR2_LINUX_KERNEL \
          --set-str BR2_LINUX_KERNEL_DEFCONFIG "x86_64_defconfig" \
          \
          --enable BR2_PACKAGE_XORG7 \
          --enable BR2_PACKAGE_XSERVER_XORG_SERVER \
          --enable BR2_PACKAGE_XINIT \
          --enable BR2_PACKAGE_FLUXBOX \
          \
          --enable BR2_PACKAGE_GRUB2 \
          --enable BR2_TARGET_ROOTFS_ISO9660 \
          --set-str BR2_TARGET_ROOTFS_ISO9660_VOLUME_ID "TrixieOS"

        make olddefconfig

    - name: Build ISO
      run: |
        cd buildroot
        make -j$(nproc)

    - name: Collect ISO
      run: |
        cp buildroot/output/images/rootfs.iso9660 TrixieOS.iso

    - uses: actions/upload-artifact@v4
      with:
        name: TrixieOS
        path: TrixieOS.iso
